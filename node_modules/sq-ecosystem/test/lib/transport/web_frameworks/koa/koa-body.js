/**
 * Copyright (c) 2016 - 2021 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Hook = require('../../../../../lib/transport/web_frameworks/koa_versions/koa_modules/koa-body');
const kIsBodyParser = require('../../../../../lib/transport/web_frameworks/koa_versions/common').kIsBodyParser;
const getEcosystemMock = require('../../../../test_utils').getEcosystemMock;
const INTERFACES = require('../../../../../lib/enums').INTERFACES;

const BodyParser = require('koa-body');

describe('koa-body', () => {

    it('should add kIsBodyParser Symbol to middleware', { plan: 3 }, (done) => {

        const iFace = getEcosystemMock();

        iFace[INTERFACES.INSTRUMENTATION].setWrapCallback = function (name, cb) {

            expect(name).to.equal('koa-body');

            const res = cb(BodyParser);

            expect(res).to.not.equal(BodyParser);

            const middleware = res();

            expect(middleware[kIsBodyParser]).to.be.true();

            done();
        };

        Hook.enable(iFace);
    });
});
